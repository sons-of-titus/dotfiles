#!/bin/bash
# Random Wallpaper Script for Hyprpaper
# Save this as ~/.config/hypr/random-wallpaper.sh
# Make executable: chmod +x ~/.config/hypr/random-wallpaper.sh

WALLPAPER_DIR="$HOME/Pictures"
CONFIG_FILE="$HOME/.config/hypr/hyprpaper.conf"

# Find a random image from the wallpaper directory
# Supports jpg, jpeg, png, webp formats
RANDOM_WALLPAPER=$(find "$WALLPAPER_DIR" -type f \
    \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) \
    | shuf -n 1)

if [ -z "$RANDOM_WALLPAPER" ]; then
    echo "No wallpapers found in $WALLPAPER_DIR"
    exit 1
fi

echo "Selected wallpaper: $RANDOM_WALLPAPER"

# Get list of monitors from hyprctl
MONITORS=$(hyprctl monitors -j | jq -r '.[].name')

if [ -z "$MONITORS" ]; then
    echo "No monitors detected! Falling back to eDP-1"
    MONITORS="eDP-1"
fi

# Check if hyprpaper is running
if ! pgrep -x hyprpaper > /dev/null; then
    echo "Starting hyprpaper..."
    
    # Create initial config with preload and wallpaper settings
    cat > "$CONFIG_FILE" << EOF
# Hyprpaper Configuration
# Auto-generated by random-wallpaper.sh

preload = $RANDOM_WALLPAPER

EOF

    # Add wallpaper setting for each monitor
    while IFS= read -r monitor; do
        echo "wallpaper = $monitor,$RANDOM_WALLPAPER" >> "$CONFIG_FILE"
    done <<< "$MONITORS"

    cat >> "$CONFIG_FILE" << EOF

splash = false
ipc = on
EOF

    # Start hyprpaper
    hyprpaper &
    sleep 1
else
    echo "Hyprpaper is running, using IPC..."
    
    # Use IPC to change wallpaper on the fly
    hyprctl hyprpaper preload "$RANDOM_WALLPAPER"
    
    # Set wallpaper for each monitor
    while IFS= read -r monitor; do
        echo "Setting wallpaper for monitor: $monitor"
        hyprctl hyprpaper wallpaper "$monitor,$RANDOM_WALLPAPER"
    done <<< "$MONITORS"
fi

echo "Wallpaper set successfully!"
